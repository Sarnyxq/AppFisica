<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Grimorio dell'Apprendista Stregone</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="assets/css/theme.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/animations.css">
    <link rel="stylesheet" href="assets/css/story.css">
</head>
<body class="min-h-screen font-serif" style="background: linear-gradient(135deg, #f4efdf, #e8dcc6);">
    <div id="eraser-cursor" class="hidden"></div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
        <div class="card p-8 md:p-12 rounded-lg max-w-3xl w-full">
            <h1 class="font-dnd text-5xl md:text-7xl text-ink-dark mb-4">Il Grimorio dell'Apprendista Stregone</h1>
            <p class="mb-6 text-lg text-ink-light">Benvenuto, giovane apprendista, nel regno arcano della Fisica. Questo antico grimorio racchiude i segreti delle forze che governano l'universo. Dalle umili misure alle leggi supreme del moto, ogni pagina ti condurrÃ  verso la maestria dei fenomeni naturali.</p>
            <p class="mb-8 text-lg text-ink-light">Scrivi il tuo nome nel registro degli apprendisti e inizia il tuo viaggio verso la saggezza fisica.</p>
            <input type="text" id="player-name-input" placeholder="Nome dell'Apprendista" class="w-full max-w-sm p-2 border-2 border-ink rounded bg-pergamena text-center text-lg mb-6">
            <button id="start-journey-btn" class="btn-primary font-dnd text-2xl px-8 py-3 rounded-lg">Inizia il Percorso Arcano</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Header with Navigation -->
        <header id="header"></header>

        <!-- Main Content Area -->
        <main id="main-content" class="container mx-auto p-4 md:p-8">
            <!-- Content will be dynamically loaded here -->
        </main>

        <!-- Challenge Modal -->
        <div id="challenge-modal" class="hidden"></div>

        <!-- Challenge Story Modal -->
        <div id="challenge-story-modal" class="hidden"></div>

        <!-- Completion Story Modal -->
        <div id="completion-story-modal" class="hidden"></div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden"></div>

        <!-- Diary Modal -->
        <div id="diary-modal" class="hidden"></div>

        <!-- Seal Modal -->
        <div id="seal-modal" class="hidden"></div>

        <!-- Notification Area -->
        <div id="notification-area" class="fixed bottom-5 right-5 z-50"></div>
    </div>

    <!-- Script Modules -->
    <script src="data/castleData.js"></script>
    <script src="data/storyData.js"></script>
    <script src="modules/storageManager.js"></script>
    <script src="modules/gameState.js"></script>
    <script src="modules/notificationSystem.js"></script>
    <script src="components/modals.js"></script>
    <script src="components/settingsModal.js"></script>
    <script src="components/header.js"></script>
    <script src="components/canvas.js"></script>
    <script src="modules/castleMap.js"></script>
    <script src="modules/wingView.js"></script>
    <script src="modules/trophyHall.js"></script>
    <script src="modules/memoryHall.js"></script>
    <script src="modules/diaryHall.js"></script>
    <script src="assets/js/app.js"></script>

    <!-- Welcome Screen Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('start-journey-btn');
            const playerNameInput = document.getElementById('player-name-input');
            const welcomeScreen = document.getElementById('welcome-screen');
            const mainApp = document.getElementById('main-app');

            function launchAppAndMap(){
                // Avvia interfaccia principale quando l'app Ã¨ pronta
                const doRender = () => { 
                    if (window.castleMap) {
                        castleMap.render();
                        // Forza aggiornamento UI per sincronizzare l'esperienza
                        if (window.gameState && gameState.isInitialized) {
                            gameState.updateUI();
                        }
                    }
                };
                if (window.fisicaApp && window.fisicaApp.isInitialized){ 
                    doRender(); 
                } else {
                    document.addEventListener('fisicaAppReady', doRender, { once:true });
                }
            }

            function hideWelcome(){ welcomeScreen && (welcomeScreen.style.display='none'); mainApp && mainApp.classList.remove('hidden'); }

            // Auto-skip se progressi giÃ  salvati con playerName
            let existingName = '';
            try {
                if (window.storageManager) {
                    const prog = storageManager.loadProgress();
                    if (prog && prog.playerName) existingName = prog.playerName;
                }
                if (!existingName) {
                    // fallback legacy chiave semplice
                    existingName = localStorage.getItem('grimorio_fisica_playerName') || '';
                }
            } catch(e) { console.warn('Errore lettura nome salvato', e); }
            if (existingName) {
                if (playerNameInput) playerNameInput.value = existingName;
                // Se gameState giÃ  caricato sincronizza
                if (window.gameState){ gameState.playerState.playerName = existingName; gameState.save(); }
                hideWelcome();
                launchAppAndMap();
            }

            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    const playerName = (playerNameInput?.value||'').trim();
                    if (!playerName) { alert('Inserisci il tuo nome per iniziare il viaggio arcano!'); playerNameInput && playerNameInput.focus(); return; }

                    // Inizializza o aggiorna stato
                    if (window.gameState){
                        if (!gameState.playerState.playerName){
                            gameState.startNewGame(playerName);
                        } else {
                            gameState.playerState.playerName = playerName; gameState.save();
                        }
                    } else {
                        localStorage.setItem('grimorio_fisica_playerName', playerName);
                    }

                    hideWelcome();
                    launchAppAndMap();
                });
            }

            // Enter per confermare
            if (playerNameInput) {
                playerNameInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') startBtn?.click(); });
                if (!existingName) setTimeout(()=>playerNameInput.focus(),100);
            }
        });
    </script>

    <!-- Story Review Modal (per rileggere storie di sfide completate) -->
    <div id="story-review-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[90] flex items-center justify-center p-4"
         role="dialog" aria-modal="true" aria-labelledby="story-review-title" aria-describedby="story-review-subtitle">
        <div class="bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 rounded-xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden shadow-2xl border-2 border-amber-400">
            <!-- Header del Modal -->
            <div class="bg-gradient-to-r from-amber-600 to-amber-500 p-6 text-center relative flex-shrink-0">
                <button id="story-review-close-btn" class="absolute top-4 right-4 text-amber-100 hover:text-white transition-colors text-2xl"
                        aria-label="Chiudi modal storia">
                    âœ•
                </button>
                <div class="flex items-center justify-center gap-3 mb-2">
                    <span id="story-review-icon" class="text-4xl" aria-hidden="true">ðŸ“–</span>
                    <h2 id="story-review-title" class="text-2xl font-dnd text-amber-100">
                        Storia della Sfida
                    </h2>
                </div>
                <p id="story-review-subtitle" class="text-amber-200 text-sm">
                    Sfida completata - Rileggi la narrazione
                </p>
            </div>

            <!-- Contenuto scrollabile -->
            <div class="flex-1 overflow-y-auto p-6" role="main">
                <div id="story-review-content" class="space-y-6">
                    <!-- Il contenuto verrÃ  caricato dinamicamente -->
                </div>
            </div>

            <!-- Footer con azioni -->
            <div class="bg-gradient-to-r from-purple-800 to-indigo-800 p-4 flex justify-center flex-shrink-0">
                <button id="story-review-close-footer-btn" class="bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold px-6 py-2 rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"
                        aria-label="Chiudi modal e torna alla vista precedente">
                    âœ¨ Chiudi
                </button>
            </div>
        </div>
    </div>
</body>
</html>
